<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Child Labour Detection System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  <style>
    .hidden { display: none; }
    #progressBar { width: 0%; height: 10px; background-color: #4CAF50; transition: width 0.3s; }
    .result-container { margin-top: 20px; padding: 15px; border: 1px solid #ccc; }
    textarea { width: 100%; height: 150px; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-child"></i></div>
      <h1>Child Labour Detection</h1>
    </div>
    <p class="subtitle">Upload a short work video (Adult/Child) â€” our system will sample frames and detect if a child is working.</p>
  </header>

  <div class="main-content">
    <section class="upload-section">
      <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
      <div class="upload-text">
        <h2>Upload Your Video</h2>
        <p>Supported formats: MP4, AVI, MOV, WMV (Max: 100MB)</p>
      </div>
      <div class="uploader">
        <div class="file-input-wrapper">
          <!-- Key fix: added name="video" -->
          <input id="videoInput" type="file" accept="video/*" name="video" />
          <label for="videoInput" class="file-input-label"><i class="fas fa-video"></i> Choose Video File</label>
        </div>
        <button id="uploadBtn"><i class="fas fa-search"></i> Upload & Detect</button>
      </div>
    </section>

    <section class="video-preview-section">
      <h2>Video Preview</h2>
      <div class="video-container">
        <video id="videoPreview" class="hidden" controls></video>
        <div class="video-placeholder" id="videoPlaceholder">
          <i class="fas fa-film"></i>
          <p>Video preview will appear here after selection</p>
        </div>
      </div>
      <div class="video-info">
        <span id="videoName">No video selected</span>
        <span id="videoDuration">--:--</span>
      </div>
    </section>
  </div>

  <div id="progress" class="hidden">
    <div class="progress-container" style="width: 100%; background: #eee;">
      <div id="progressBar"></div>
    </div>
    <span id="progressText">Uploading...</span>
  </div>

  <div id="result" class="result-container hidden">
    <h3 class="result-title">Detection Result</h3>
    <div class="result-content">
      <div class="result-icon">
        <i class="fas fa-question"></i>
      </div>
      <div class="result-message" id="resultMessage">Processing your video...</div>
      <div class="detection-details">
        <h3>Detection Details</h3>
        <textarea id="detectionInfo" readonly placeholder="Detection details will appear here..."></textarea>
      </div>
    </div>
  </div>

  <div class="logs-section">
    <a href="{{ url_for('get_logs') }}" target="_blank" class="logs-link">
      <i class="fas fa-download"></i> Download detection logs (CSV)
    </a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const videoInput = document.getElementById('videoInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const progress = document.getElementById('progress');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const result = document.getElementById('result');
  const resultMessage = document.getElementById('resultMessage');
  const detectionInfo = document.getElementById('detectionInfo');
  const videoPreview = document.getElementById('videoPreview');
  const videoPlaceholder = document.getElementById('videoPlaceholder');
  const videoName = document.getElementById('videoName');
  const videoDuration = document.getElementById('videoDuration');

  // Video preview
  videoInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const file = this.files[0];
      videoName.textContent = file.name;
      const fileURL = URL.createObjectURL(file);
      videoPreview.src = fileURL;
      videoPreview.classList.remove('hidden');
      videoPlaceholder.classList.add('hidden');

      videoPreview.addEventListener('loadedmetadata', function() {
        const duration = videoPreview.duration;
        const minutes = Math.floor(duration / 60);
        const seconds = Math.floor(duration % 60);
        videoDuration.textContent = `${minutes}:${seconds.toString().padStart(2,'0')}`;
      });
    } else {
      videoName.textContent = "No video selected";
      videoDuration.textContent = "--:--";
      videoPreview.classList.add('hidden');
      videoPlaceholder.classList.remove('hidden');
    }
  });

  // Upload & AJAX with progress
  uploadBtn.addEventListener('click', function() {
    if (!videoInput.files[0]) { alert('Please select a video.'); return; }

    const formData = new FormData();
    formData.append('video', videoInput.files[0]);

    progress.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = 'Uploading...';
    result.classList.add('hidden');

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload', true);

    xhr.upload.onprogress = function(e) {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        progressBar.style.width = percent + '%';
        progressText.textContent = `Uploading... ${Math.round(percent)}%`;
      }
    };

    xhr.onload = function() {
      progress.classList.add('hidden');
      result.classList.remove('hidden');
      const data = JSON.parse(xhr.responseText);

      if(data.error){
        resultMessage.textContent = data.error;
        detectionInfo.value = '';
      } else {
        resultMessage.textContent = data.message;
        if (data.details && data.details.length > 0) {
          let text = '';
          data.details.forEach(d => {
            text += `Timestamp: ${d.timestamp}\nActivity: ${d.activity}\nConfidence: ${d.confidence}%\nLocation: x=${d.location.x_percent}%, y=${d.location.y_percent}%\n\n`;
          });
          detectionInfo.value = text;
        } else {
          detectionInfo.value = '';
        }
      }
    };

    xhr.onerror = function() {
      progress.classList.add('hidden');
      alert('Upload failed.');
    };

    xhr.send(formData);
  });
});
</script>
</body>
</html>
